<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meesho Label Cropper </title>

    <!-- FAVICON LINK: Added a simple box icon using inline SVG -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }

        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            background-color: white;
        }

        .group-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
        }
    </style>
    <!-- Load PDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.js';
    </script>
</head>

<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-4xl container-card p-6 sm:p-10 rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            <svg class="w-8 h-8 mr-3 text-indigo-600" fill="currentColor" viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.414L16.586 7A2 2 0 0117 8.414V16a2 2 0 01-2 2H5a2 2 0 01-2-2V4zm5 10a1 1 0 000 2h2a1 1 0 100-2H9zm-2-5a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z"
                    clip-rule="evenodd"></path>
            </svg>
            Meesho Label Cropper (By Product/SKU)
        </h1>
        <p class="text-gray-600 mb-8">Upload your multi-page Meesho label PDF. The tool will extract the **SKU (Product
            Details)** to sort and group similar items, filter blank pages, and export a new PDF (all done in your
            browser).</p>

        <!-- Main Upload Area -->
        <div id="upload-section"
            class="bg-indigo-50 border-2 border-indigo-200 border-dashed rounded-lg p-6 text-center transition duration-300 hover:border-indigo-400">
            <input type="file" id="pdfFile" accept=".pdf" class="hidden" onchange="handleFileChange(event)">
            <label for="pdfFile" class="cursor-pointer">
                <div class="flex flex-col items-center justify-center p-4">
                    <svg class="w-12 h-12 text-indigo-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m0 0l-3-3m3 3l3-3">
                        </path>
                    </svg>
                    <p class="text-lg font-semibold text-indigo-600">Drag & drop or Click to upload PDF</p>
                    <p class="text-sm text-gray-500 mt-1">Only .pdf files are accepted (max size 50MB)</p>
                </div>
            </label>
        </div>

        <!-- Processing & Results Area -->
        <div id="status-area" class="mt-8 hidden">
            <div id="loading-indicator"
                class="flex items-center justify-center p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow-inner">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span id="status-message" class="font-medium">Loading PDF...</span>
            </div>

            <div id="result-area" class="hidden mt-6">
                <div class="bg-green-100 text-green-800 p-4 rounded-lg flex items-center justify-between">
                    <span class="font-medium" id="success-message">Processing Complete!</span>
                    <button id="download-button" onclick="downloadPdf()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        Download Sorted PDF
                    </button>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">Summary:</h3>
                    <p class="text-sm text-gray-600" id="summary-output"></p>
                </div>

                <!-- NEW: Account Name Breakdown -->
                <div class="mt-8 pt-4 border-t border-gray-300">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">
                        Orders by Meesho Account ðŸ‘¤
                    </h3>
                    <div id="account-count-breakdown" class="space-y-3">
                        <!-- Account counts will be injected here -->
                    </div>
                </div>

                <!-- SKU Count Breakdown -->
                <div class="mt-8 pt-4 border-t border-gray-300">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">
                        SKU Label Breakdown ðŸ“¦
                    </h3>
                    <div id="sku-count-breakdown" class="space-y-3">
                        <!-- SKU list and counts will be injected here -->
                    </div>
                </div>


            </div>

            <div id="error-area" class="hidden mt-6 bg-red-100 text-red-800 p-4 rounded-lg shadow-inner">
                <p class="font-medium">Error during processing:</p>
                <p class="text-sm mt-1" id="error-message"></p>
            </div>
        </div>

        <!-- Custom Grouping Section -->
        <div id="grouping-section" class="mt-8 hidden">
            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                        </svg>
                        Custom SKU Grouping
                    </h2>
                    <button onclick="proceedWithoutGrouping()"
                        class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Skip & Use Auto-Sort
                    </button>
                </div>
                <p class="text-gray-600 mb-6">Create custom groups and assign SKUs to organize your labels exactly how
                    you want.</p>

                <!-- Detected SKUs List -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Detected SKUs (Click to add to group)</h3>
                    <div id="detected-skus-list"
                        class="bg-white p-4 rounded-lg border border-gray-200 max-h-64 overflow-y-auto">
                        <!-- SKUs will be populated here -->
                    </div>
                </div>

                <!-- Groups Management -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-700">Your Groups</h3>
                        <button onclick="addNewGroup()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                            + Add Group
                        </button>
                    </div>
                    <div id="groups-container" class="space-y-4">
                        <!-- Groups will be populated here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    <button onclick="applyCustomGrouping()"
                        class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200">
                        Apply Custom Grouping & Download
                    </button>
                    <button onclick="resetGrouping()"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-6 rounded-lg transition duration-200">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Professional Footer Credit -->
        <div class="mt-10 pt-6 border-t border-gray-200">
            <div class="flex flex-col items-center justify-center space-y-2">
                <p class="text-sm text-gray-500">
                    Developed by
                </p>
                <a href="https://dashinfotech.com/" target="_blank" rel="noopener noreferrer"
                    class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg shadow-md hover:from-indigo-700 hover:to-purple-700 transition duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                    </svg>
                    Dash Infotech
                </a>
                <p class="text-xs text-gray-400 mt-2">
                    Innovative Solutions for Modern Businesses
                </p>
            </div>
        </div>

    </div>

    <script>
        // Global constants for PDF Cropping
        const MM_TO_POINTS = 72 / 25.4;
        const TARGET_WIDTH_MM = 220;
        const TARGET_HEIGHT_MM = 210;
        const TARGET_WIDTH_POINTS = TARGET_WIDTH_MM * MM_TO_POINTS;
        const TARGET_HEIGHT_POINTS = TARGET_HEIGHT_MM * MM_TO_POINTS;

        // Global variables
        let sortedPdfBytes = null;
        let uniqueSkuCounts = {};
        let detectedSkuData = {}; // Stores all SKU data with page indices
        let customGroups = []; // Array of group objects
        let groupCounter = 1;
        let pdfDocumentData = null; // Store PDF data for reprocessing
        let accountNameCounts = {}; // Stores order counts by account name

        // Storage keys
        const STORAGE_KEYS = {
            GROUPS: 'meesho_custom_groups',
            GROUP_COUNTER: 'meesho_group_counter'
        };

        // Color palette for groups
        const groupColors = [
            { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
            { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
            { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
            { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' },
            { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-300' },
            { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-300' },
            { bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-300' },
            { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-300' },
        ];

        // Storage functions
        function saveGroupsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.GROUPS, JSON.stringify(customGroups));
                localStorage.setItem(STORAGE_KEYS.GROUP_COUNTER, groupCounter.toString());
                console.log('Groups saved to storage');
            } catch (error) {
                console.error('Failed to save groups:', error);
            }
        }

        function loadGroupsFromStorage() {
            try {
                const savedGroups = localStorage.getItem(STORAGE_KEYS.GROUPS);
                const savedCounter = localStorage.getItem(STORAGE_KEYS.GROUP_COUNTER);

                if (savedGroups) {
                    customGroups = JSON.parse(savedGroups);
                    console.log(`Loaded ${customGroups.length} groups from storage`);
                }

                if (savedCounter) {
                    groupCounter = parseInt(savedCounter, 10);
                }

                return customGroups.length > 0;
            } catch (error) {
                console.error('Failed to load groups:', error);
                return false;
            }
        }

        function clearStoredGroups() {
            try {
                localStorage.removeItem(STORAGE_KEYS.GROUPS);
                localStorage.removeItem(STORAGE_KEYS.GROUP_COUNTER);
                console.log('Cleared stored groups');
            } catch (error) {
                console.error('Failed to clear stored groups:', error);
            }
        }

        function updateStatus(message, isError = false) {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('status-area').classList.remove('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('error-area').classList.add('hidden');
            document.getElementById('grouping-section').classList.add('hidden');

            document.getElementById('status-message').textContent = message;

            if (isError) {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('error-area').classList.remove('hidden');
                document.getElementById('error-message').textContent = message;
            }
        }

        function showResult(message, summary) {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('error-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('success-message').textContent = message;
            document.getElementById('summary-output').textContent = summary;
        }

        function resetUI() {
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('status-area').classList.add('hidden');
            document.getElementById('grouping-section').classList.add('hidden');
            document.getElementById('pdfFile').value = '';
            document.getElementById('sku-count-breakdown').innerHTML = '';
            sortedPdfBytes = null;
            uniqueSkuCounts = {};
            detectedSkuData = {};
            accountNameCounts = {}; // Reset account counts
            customGroups = [];
            groupCounter = 1;
            pdfDocumentData = null;
        }

        function normalizeSkuForGrouping(sku) {
            let strippedSku = sku.replace(/\s+\d+$/g, '');
            strippedSku = strippedSku.replace(/(\s\d+)/g, '');
            return strippedSku;
        }

        /**
         * Extracts the Meesho account name from the label text.
         * @param {string} rawText The extracted text content of a page.
         * @returns {string} The extracted account name or 'Unknown Account'.
         */
        function extractAccountName(rawText) {
            // Primary Pattern: Look for "If undelivered, return to:" followed by the account name
            const returnToPattern = /If undelivered,?\s*return to\s*:?\s*([A-Za-z0-9\s\.\-&]+?)(?:\r|\s\s)/i;

            let match = rawText.match(returnToPattern);
            console.log(match);

            if (match && match[1]) {
                const accountName = match[1].trim();
                // Validate: reasonable length and not just numbers
                if (accountName.length > 2 && accountName.length < 60 && !/^\d+$/.test(accountName)) {
                    return accountName;
                }
            }

            // Fallback Pattern 1: Look for "Sold by:" or "Seller:" followed by the name
            const soldByPattern = /(?:Sold by|Seller)\s*:?\s*([A-Za-z0-9\s\.\-&]+?)(?:\s*(?:Email|Phone|Address|HSN|TAX|GSTIN|Contact|Mobile))/i;
            match = rawText.match(soldByPattern);

            if (match && match[1]) {
                const accountName = match[1].trim();
                if (accountName.length > 2 && accountName.length < 60 && !/^\d+$/.test(accountName)) {
                    return accountName;
                }
            }

            // Fallback Pattern 2: Look for account name near "Supplier" or "Vendor"
            const supplierPattern = /(?:Supplier|Vendor)\s*:?\s*([A-Za-z0-9\s\.\-&]+?)(?:\s*(?:Email|Phone|Address|HSN|TAX|GSTIN))/i;
            match = rawText.match(supplierPattern);

            if (match && match[1]) {
                const accountName = match[1].trim();
                if (accountName.length > 2 && accountName.length < 60 && !/^\d+$/.test(accountName)) {
                    return accountName;
                }
            }

            // Fallback Pattern 3: Extract from "From" section
            const fromPattern = /(?:From)\s*:?\s*([A-Za-z0-9\s\.\-&]+?)(?:\s*(?:\d|,|Email|Phone|Address|Contact))/i;
            match = rawText.match(fromPattern);

            if (match && match[1]) {
                const accountName = match[1].trim();
                if (accountName.length > 2 && accountName.length < 60 && !/^\d+$/.test(accountName)) {
                    return accountName;
                }
            }

            return 'Unknown Account';
        }

        function extractSku(rawText) {
            let descriptiveSku = '';

            const skuPattern1 = /(?:SKU\s*Size\s*Qty\s*Color\s*Order No\.)\s*([\w\-\s]+?)\s*(?:Size|Qty|Color|Free Size)/i;
            let skuMatch1 = rawText.match(skuPattern1);

            if (skuMatch1 && skuMatch1[1]) {
                descriptiveSku = skuMatch1[1].trim();
            }

            if (!descriptiveSku) {
                const fallbackSkuPattern = /SKU\s*(\W*([\w\-\s]+?))\s*(?:Size|Qty|Color|Order No|TAX INVOICE)/i;
                let fallbackMatch = rawText.match(fallbackSkuPattern);
                if (fallbackMatch && fallbackMatch[2]) {
                    descriptiveSku = fallbackMatch[2].trim();
                }
            }

            if (descriptiveSku && descriptiveSku.length > 2) {
                const groupedSku = normalizeSkuForGrouping(descriptiveSku);
                const normalizedSku = groupedSku.toUpperCase().replace(/[^A-Z0-9]/g, '').trim();
                const sortingKey = 'SKU_PRD-' + normalizedSku;

                if (!uniqueSkuCounts[sortingKey]) {
                    uniqueSkuCounts[sortingKey] = {
                        rawSku: descriptiveSku,
                        count: 1
                    };
                } else {
                    uniqueSkuCounts[sortingKey].count++;
                }

                return sortingKey;
            }

            const hsnMatch = rawText.match(/(?:HSN|SKU)\s*([0-9]{6,10})|("HSN"\s*,"Qty"\s*,"Gross Amount"\s*,"Discount"\s*[^,]+,\s*"([0-9]{6,10}))/i);
            if (hsnMatch && (hsnMatch[1] || hsnMatch[3])) {
                const hsnCode = (hsnMatch[1] || hsnMatch[3]).trim();
                const sortingKey = 'SKU_HSN-' + hsnCode;

                if (!uniqueSkuCounts[sortingKey]) {
                    uniqueSkuCounts[sortingKey] = {
                        rawSku: `HSN: ${hsnCode}`,
                        count: 1
                    };
                } else {
                    uniqueSkuCounts[sortingKey].count++;
                }

                return sortingKey;
            }

            const purchaseOrderMatch = rawText.match(/Purchase Order\s*(\d{10,20})/);
            if (purchaseOrderMatch) {
                const orderId = purchaseOrderMatch[1].trim();
                return 'ORDER-' + orderId;
            }

            return 'UNKNOWN_SORT_FALLBACK';
        }

        async function getTextFromPdfPage(pdfDocument, pageNumber) {
            const page = await pdfDocument.getPage(pageNumber);
            const textContent = await page.getTextContent();
            return textContent.items.map(item => item.str).join(' ');
        }

        function renderSkuCounts() {
            const skuListDiv = document.getElementById('sku-count-breakdown');
            skuListDiv.innerHTML = '';

            const uniqueSkus = Object.keys(uniqueSkuCounts);

            if (uniqueSkus.length === 0) {
                skuListDiv.innerHTML = '<p class="text-sm text-gray-500">No unique products with a detectable SKU were found for counting.</p>';
                return;
            }

            const sortedCounts = Object.entries(uniqueSkuCounts)
                .map(([key, value]) => ({ key, ...value }))
                .sort((a, b) => a.key.localeCompare(b.key));

            sortedCounts.forEach(data => {
                const cleanSkuName = data.rawSku.trim();

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                item.innerHTML = `
                    <p class="font-medium text-gray-800 break-all mr-4">
                        ${cleanSkuName}
                    </p>
                    <span class="text-lg font-bold text-indigo-600">
                        ${data.count}
                    </span>
                `;
                skuListDiv.appendChild(item);
            });
        }

        function renderAccountCounts() {
            const accountListDiv = document.getElementById('account-count-breakdown');
            accountListDiv.innerHTML = '';

            const accounts = Object.keys(accountNameCounts);

            if (accounts.length === 0) {
                accountListDiv.innerHTML = '<p class="text-sm text-gray-500">No account information detected.</p>';
                return;
            }

            // Sort by count (descending), then alphabetically
            const sortedAccounts = Object.entries(accountNameCounts)
                .sort((a, b) => {
                    if (b[1] !== a[1]) return b[1] - a[1]; // Sort by count descending
                    return a[0].localeCompare(b[0]); // Then alphabetically
                });

            const totalOrders = sortedAccounts.reduce((sum, [, count]) => sum + count, 0);

            // Add total summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'p-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg shadow-md mb-4';
            summaryCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Total Orders</p>
                        <p class="text-3xl font-bold">${totalOrders}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm opacity-90">Accounts</p>
                        <p class="text-3xl font-bold">${accounts.length}</p>
                    </div>
                </div>
            `;
            accountListDiv.appendChild(summaryCard);

            // Add individual account cards
            sortedAccounts.forEach(([accountName, count]) => {
                const percentage = ((count / totalOrders) * 100).toFixed(1);

                const item = document.createElement('div');
                item.className = 'bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden';
                item.innerHTML = `
                    <div class="flex items-center justify-between p-4">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-lg">${accountName}</p>
                            <p class="text-sm text-gray-500 mt-1">${percentage}% of total orders</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-purple-600">${count}</span>
                            <p class="text-xs text-gray-500">orders</p>
                        </div>
                    </div>
                    <div class="h-2 bg-gray-100">
                        <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: ${percentage}%"></div>
                    </div>
                `;
                accountListDiv.appendChild(item);
            });
        }

        async function processPdf(arrayBuffer, showGroupingUI = true) {
            try {
                uniqueSkuCounts = {};
                detectedSkuData = {};

                updateStatus('Starting PDF processing...');

                const pdfjsDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);

                // Store for later use
                pdfDocumentData = {
                    arrayBuffer: arrayBuffer,
                    pdfjsDoc: pdfjsDoc,
                    pdfLibDoc: pdfLibDoc
                };

                const numPages = pdfLibDoc.getPages().length;

                if (numPages === 0) {
                    throw new Error("The PDF file contains no pages.");
                }

                const pageData = [];
                let pagesRemoved = 0;

                updateStatus(`Processing ${numPages} pages and extracting SKU/HSN...`);

                for (let i = 0; i < numPages; i++) {
                    const pageIndex = i;
                    const pageNumber = i + 1;

                    const rawText = await getTextFromPdfPage(pdfjsDoc, pageNumber);

                    if (rawText.length < 30) {
                        pagesRemoved++;
                        continue;
                    }

                    const sku = extractSku(rawText);
                    const accountName = extractAccountName(rawText);

                    // Count orders by account name
                    if (!accountNameCounts[accountName]) {
                        accountNameCounts[accountName] = 0;
                    }
                    accountNameCounts[accountName]++;

                    pageData.push({
                        pageIndex: pageIndex,
                        sku: sku,
                        accountName: accountName,
                        rawTextLength: rawText.length,
                    });

                    // Store in detectedSkuData for grouping UI
                    if (!detectedSkuData[sku]) {
                        detectedSkuData[sku] = {
                            rawSku: uniqueSkuCounts[sku]?.rawSku || sku,
                            pageIndices: []
                        };
                    }
                    detectedSkuData[sku].pageIndices.push(pageIndex);
                }

                const pagesKept = pageData.length;
                if (pagesKept === 0) {
                    throw new Error("No non-blank pages found in the uploaded PDF. Please check your source file.");
                }

                if (showGroupingUI) {
                    // Load saved groups before showing UI
                    const hasStoredGroups = loadGroupsFromStorage();

                    // Show grouping UI
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('grouping-section').classList.remove('hidden');
                    renderDetectedSkus();
                    renderGroups();

                    // Show notification if groups were loaded
                    if (hasStoredGroups) {
                        showNotification(`Loaded ${customGroups.length} saved group(s)`, 'success');
                    }
                } else {
                    // Auto-sort without grouping
                    await finalizePdfWithSorting(pageData, pagesRemoved, numPages);
                }

            } catch (error) {
                console.error('Processing error:', error);
                updateStatus(`Failed to process PDF: ${error.message}`, true);
            }
        }

        async function finalizePdfWithSorting(pageData, pagesRemoved, originalNumPages) {
            try {
                updateStatus('Sorting and creating PDF...');

                pageData.sort((a, b) => {
                    return a.sku.localeCompare(b.sku);
                });

                const newPdfDoc = await PDFLib.PDFDocument.create();

                for (const pageInfo of pageData) {
                    const originalPage = pdfDocumentData.pdfLibDoc.getPages()[pageInfo.pageIndex];

                    if (!originalPage) {
                        continue;
                    }

                    const embeddedPage = await newPdfDoc.embedPage(originalPage);
                    const embeddedWidth = Number(embeddedPage.width);
                    const embeddedHeight = Number(embeddedPage.height);

                    if (isNaN(embeddedWidth) || isNaN(embeddedHeight)) {
                        continue;
                    }

                    const croppedPage = newPdfDoc.addPage([TARGET_WIDTH_POINTS, TARGET_HEIGHT_POINTS]);
                    const yOffset = croppedPage.getHeight() - embeddedHeight;

                    croppedPage.drawPage(embeddedPage, {
                        x: 0,
                        y: yOffset,
                        width: embeddedWidth,
                        height: embeddedHeight,
                    });
                }

                updateStatus('Finalizing document...');
                sortedPdfBytes = await newPdfDoc.save();

                const summary = `Original Pages: ${originalNumPages} | Pages Kept: ${pageData.length} | Pages Removed: ${pagesRemoved}`;

                showResult('Sorting and Cropping Complete!', summary);
                renderAccountCounts(); // Render account breakdown
                renderSkuCounts();


            } catch (error) {
                console.error('Finalization error:', error);
                updateStatus(`Failed to create PDF: ${error.message}`, true);
            }
        }

        function renderDetectedSkus() {
            const container = document.getElementById('detected-skus-list');
            container.innerHTML = '';

            const skus = Object.keys(detectedSkuData);

            if (skus.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No SKUs detected</p>';
                return;
            }

            skus.forEach(skuKey => {
                const data = detectedSkuData[skuKey];
                const count = data.pageIndices.length;

                const skuItem = document.createElement('div');
                skuItem.className = 'flex items-center justify-between p-3 mb-2 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 cursor-pointer transition duration-200';
                skuItem.onclick = () => showSkuAssignmentModal(skuKey);
                skuItem.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${data.rawSku}</p>
                        <p class="text-xs text-gray-500">${count} label(s)</p>
                    </div>
                    <div id="sku-badges-${skuKey.replace(/[^a-zA-Z0-9]/g, '')}" class="flex flex-wrap gap-1">
                        <!-- Group badges will appear here -->
                    </div>
                    <svg class="w-5 h-5 text-gray-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;
                container.appendChild(skuItem);
            });
        }

        function addNewGroup() {
            const colorIndex = (customGroups.length) % groupColors.length;
            const colors = groupColors[colorIndex];

            const newGroup = {
                id: `group-${groupCounter++}`,
                name: `Group ${customGroups.length + 1}`,
                skus: [],
                color: colors
            };

            customGroups.push(newGroup);
            saveGroupsToStorage(); // Save after adding
            renderGroups();
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';

            if (customGroups.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No groups yet. Click "Add Group" to create one.</p>';
                return;
            }

            customGroups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = `${group.color.bg} ${group.color.border} border-2 rounded-lg p-4`;

                const skuList = group.skus.map(skuKey => {
                    const data = detectedSkuData[skuKey];
                    if (!data) return ''; // SKU not in current PDF
                    return `<span class="inline-block bg-white px-2 py-1 rounded text-xs ${group.color.text} m-1">${data.rawSku} (${data.pageIndices.length})</span>`;
                }).filter(s => s).join('');

                groupDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="${group.name}" 
                               onchange="updateGroupName(${index}, this.value)"
                               class="flex-1 bg-white border-2 ${group.color.border} rounded-lg px-3 py-2 font-semibold ${group.color.text} focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <button onclick="deleteGroup(${index})" class="ml-3 text-red-600 hover:text-red-800 font-medium">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="min-h-[60px] bg-white bg-opacity-50 rounded-lg p-3">
                        ${skuList || '<p class="text-sm text-gray-500 italic">No SKUs from current PDF assigned yet.</p>'}
                    </div>
                `;
                container.appendChild(groupDiv);
            });
        }

        function updateGroupName(index, newName) {
            customGroups[index].name = newName;
            saveGroupsToStorage(); // Save after updating
        }

        function deleteGroup(index) {
            if (confirm(`Delete "${customGroups[index].name}"?`)) {
                customGroups.splice(index, 1);
                saveGroupsToStorage(); // Save after deleting
                renderGroups();
                renderDetectedSkus();
            }
        }

        function showSkuAssignmentModal(skuKey) {
            if (customGroups.length === 0) {
                alert('Please create at least one group first!');
                return;
            }

            const data = detectedSkuData[skuKey];
            const groupOptions = customGroups.map((group, index) => {
                const isAssigned = group.skus.includes(skuKey);
                const checkmark = isAssigned ? 'âœ“ ' : '';
                return `<div onclick="toggleSkuInGroup(${index}, '${skuKey}')" 
                             class="p-3 mb-2 ${group.color.bg} ${group.color.border} border-2 rounded-lg cursor-pointer hover:opacity-80 transition duration-200">
                    <p class="font-semibold ${group.color.text}">${checkmark}${group.name}</p>
                </div>`;
            }).join('');

            const modalHtml = `
                <div id="assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Assign to Groups</h3>
                        <p class="text-gray-600 mb-4">${data.rawSku} (${data.pageIndices.length} labels)</p>
                        <div class="max-h-64 overflow-y-auto">
                            ${groupOptions}
                        </div>
                        <button onclick="closeModal()" class="mt-4 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-200">
                            Close
                        </button>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('assignment-modal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeModal(event) {
            if (!event || event.target.id === 'assignment-modal') {
                const modal = document.getElementById('assignment-modal');
                if (modal) {
                    modal.remove();
                }
            }
        }

        function toggleSkuInGroup(groupIndex, skuKey) {
            const group = customGroups[groupIndex];
            const skuIndex = group.skus.indexOf(skuKey);

            if (skuIndex > -1) {
                group.skus.splice(skuIndex, 1);
            } else {
                group.skus.push(skuKey);
            }

            saveGroupsToStorage(); // Save after toggling
            renderGroups();
            updateSkuBadges(skuKey);

            // Refresh the modal
            closeModal();
            setTimeout(() => showSkuAssignmentModal(skuKey), 100);
        }

        function updateSkuBadges(skuKey) {
            const badgeContainer = document.getElementById(`sku-badges-${skuKey.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (!badgeContainer) return;

            badgeContainer.innerHTML = '';

            customGroups.forEach(group => {
                if (group.skus.includes(skuKey)) {
                    const badge = document.createElement('span');
                    badge.className = `group-badge ${group.color.bg} ${group.color.text}`;
                    badge.textContent = group.name;
                    badgeContainer.appendChild(badge);
                }
            });
        }

        function proceedWithoutGrouping() {
            if (!pdfDocumentData) {
                alert('No PDF data available');
                return;
            }

            const pageData = [];
            Object.keys(detectedSkuData).forEach(skuKey => {
                const data = detectedSkuData[skuKey];
                data.pageIndices.forEach(pageIndex => {
                    pageData.push({
                        pageIndex: pageIndex,
                        sku: skuKey,
                        rawTextLength: 0
                    });
                });
            });

            finalizePdfWithSorting(pageData, 0, pdfDocumentData.pdfLibDoc.getPages().length);
        }

        async function applyCustomGrouping() {
            if (customGroups.length === 0) {
                alert('Please create at least one group or use "Skip & Use Auto-Sort"');
                return;
            }

            if (!pdfDocumentData) {
                alert('No PDF data available');
                return;
            }

            try {
                updateStatus('Applying custom grouping and creating PDF...');
                document.getElementById('grouping-section').classList.add('hidden');

                const pageData = [];

                // First, add grouped SKUs in order
                customGroups.forEach((group, groupIndex) => {
                    const groupPrefix = String(groupIndex + 1).padStart(3, '0');




                    group.skus.forEach(skuKey => {
                        const data = detectedSkuData[skuKey];

                        if (!data) {
                            console.warn(`SKU key ${skuKey} found in group ${group.name}, but not detected in current PDF. Skipping.`);
                            return; // Skip this SKU
                        }
                        data.pageIndices.forEach(pageIndex => {
                            pageData.push({
                                pageIndex: pageIndex,
                                sku: `${groupPrefix}-${skuKey}`,
                                rawTextLength: 0
                            });
                        });
                    });
                });

                // Then add ungrouped SKUs at the end
                const allGroupedSkus = new Set(customGroups.flatMap(g => g.skus));
                Object.keys(detectedSkuData).forEach(skuKey => {
                    if (!allGroupedSkus.has(skuKey)) {
                        const data = detectedSkuData[skuKey];
                        if (!data) {
                            console.warn(`Ungrouped SKU key ${skuKey} missing data. Skipping.`);
                            return;
                        }
                        data.pageIndices.forEach(pageIndex => {
                            pageData.push({
                                pageIndex: pageIndex,
                                sku: `999-${skuKey}`,
                                rawTextLength: 0
                            });
                        });
                    }
                });

                if (pageData.length === 0) {
                    throw new Error("No SKUs were successfully mapped for grouping. Check your groups and uploaded file.");
                }

                // Sort by the prefixed SKU
                pageData.sort((a, b) => a.sku.localeCompare(b.sku));

                // Create the PDF
                const newPdfDoc = await PDFLib.PDFDocument.create();



                for (const pageInfo of pageData) {
                    const originalPage = pdfDocumentData.pdfLibDoc.getPages()[pageInfo.pageIndex];

                    if (!originalPage) {
                        continue;
                    }


                    const embeddedPage = await newPdfDoc.embedPage(originalPage);
                    const embeddedWidth = Number(embeddedPage.width);
                    const embeddedHeight = Number(embeddedPage.height);

                    if (isNaN(embeddedWidth) || isNaN(embeddedHeight)) {
                        continue;
                    }

                    const croppedPage = newPdfDoc.addPage([TARGET_WIDTH_POINTS, TARGET_HEIGHT_POINTS]);
                    const yOffset = croppedPage.getHeight() - embeddedHeight;

                    croppedPage.drawPage(embeddedPage, {
                        x: 0,
                        y: yOffset,
                        width: embeddedWidth,
                        height: embeddedHeight,
                    });
                }

                updateStatus('Finalizing document...');
                sortedPdfBytes = await newPdfDoc.save();

                const groupedCount = customGroups.reduce((sum, g) => sum + g.skus.length, 0);
                const ungroupedCount = Object.keys(detectedSkuData).length - groupedCount;
                const summary = `Custom Groups: ${customGroups.length} | Grouped SKUs: ${groupedCount} | Ungrouped SKUs: ${ungroupedCount} | Total Pages: ${pageData.length}`;

                showResult('Custom Grouping Applied Successfully!', summary);
                renderAccountCounts(); // Render account breakdown for custom grouping too
                renderCustomGroupSummary();


            } catch (error) {
                console.error('Grouping error:', error);
                updateStatus(`Failed to apply grouping: ${error.message}`, true);
            }
        }

        function renderCustomGroupSummary() {
            const skuListDiv = document.getElementById('sku-count-breakdown');
            skuListDiv.innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-3">Custom Groups Summary</h3>';

            customGroups.forEach(group => {
                const totalLabels = group.skus.reduce((sum, skuKey) => {
                    const data = detectedSkuData[skuKey];
                    // Only count if the SKU data exists in the current PDF
                    if (data) {
                        return sum + data.pageIndices.length;
                    }
                    return sum;
                }, 0);

                const groupDiv = document.createElement('div');
                groupDiv.className = `mb-4 ${group.color.bg} ${group.color.border} border-2 rounded-lg p-4`;

                const skuDetails = group.skus.map(skuKey => {
                   
                    const data = detectedSkuData[skuKey];
                     if(data){
                    return `<div class="flex justify-between items-center bg-white px-3 py-2 rounded mb-2">
                        <span class="text-sm text-gray-700">${data.rawSku}</span>
                        <span class="font-semibold ${group.color.text}">${data.pageIndices.length}</span>
                    </div>`;}
                }).join('');

                groupDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-bold ${group.color.text}">${group.name}</h4>
                        <span class="text-xl font-bold ${group.color.text}">${totalLabels} labels</span>
                    </div>
                    ${skuDetails}
                `;

                skuListDiv.appendChild(groupDiv);
            });

            // Show ungrouped SKUs
            const allGroupedSkus = new Set(customGroups.flatMap(g => g.skus));
            const ungroupedSkus = Object.keys(detectedSkuData).filter(sku => !allGroupedSkus.has(sku));

            if (ungroupedSkus.length > 0) {
                const ungroupedDiv = document.createElement('div');
                ungroupedDiv.className = 'mb-4 bg-gray-100 border-2 border-gray-300 rounded-lg p-4';

                const ungroupedDetails = ungroupedSkus.map(skuKey => {
                    const data = detectedSkuData[skuKey];
                    return `<div class="flex justify-between items-center bg-white px-3 py-2 rounded mb-2">
                        <span class="text-sm text-gray-700">${data.rawSku}</span>
                        <span class="font-semibold text-gray-600">${data.pageIndices.length}</span>
                    </div>`;
                }).join('');

                const totalUngrouped = ungroupedSkus.reduce((sum, skuKey) => {
                    return sum + detectedSkuData[skuKey].pageIndices.length;
                }, 0);

                ungroupedDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-bold text-gray-700">Ungrouped SKUs</h4>
                        <span class="text-xl font-bold text-gray-600">${totalUngrouped} labels</span>
                    </div>
                    ${ungroupedDetails}
                `;

                skuListDiv.appendChild(ungroupedDiv);
            }
        }

        function resetGrouping() {
            if (confirm('Reset all groups? This will delete all saved groups permanently and cannot be undone.')) {
                customGroups = [];
                groupCounter = 1;
                clearStoredGroups(); // Clear from storage
                renderGroups();
                renderDetectedSkus();
            }
        }

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) {
                resetUI();
                return;
            }

            if (file.type !== 'application/pdf') {
                updateStatus('Please upload a valid PDF file.', true);
                return;
            }
            if (file.size > 50 * 1024 * 1024) {
                updateStatus('File size exceeds 50MB limit.', true);
                return;
            }

            updateStatus('Reading file data...');

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    await processPdf(e.target.result, true);
                } catch (error) {
                    console.error('File processing error:', error);
                }
            };
            reader.onerror = function () {
                updateStatus('Failed to read the file.', true);
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadPdf() {
            if (!sortedPdfBytes) {
                const errorMessage = "No processed PDF data available for download.";
                console.error(errorMessage);
                document.getElementById('error-message').textContent = errorMessage;
                document.getElementById('error-area').classList.remove('hidden');
                return;
            }

            const blob = new Blob([sortedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meesho_labels_sorted_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            notification.className = `fixed top-4 right-4 ${bgColors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        window.onload = function () {
            resetUI();
            // Load groups on initial page load
            loadGroupsFromStorage();
        };

    </script>
</body>

</html>